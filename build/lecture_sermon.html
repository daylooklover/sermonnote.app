<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Expository Sermon Writing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìƒëµ */</style>
</head>
<body>

<h2>âœ ê°•í•´ì‹ ì„¤êµ ì‘ì„±</h2>

<label>1. ë³¸ë¬¸</label>
<textarea id="expositoryText"></textarea>

<label>2. í•´ì„ ë° ì£¼ì„</label>
<textarea id="expositoryInterpretation"></textarea>

<label>3. ì ìš© ë° ê²°ë¡ </label>
<textarea id="expositoryApplication"></textarea>

<label>ğŸ“… ë‚ ì§œ <input type="date" id="sermonDate" /></label>
<label>ğŸ“ ì£¼ì œ <input type="text" id="sermonCategory" placeholder="ì˜ˆ: ì£¼ì¼ì˜ˆë°°"/></label>

<div>
  <button id="saveBtn">ğŸ’¾ ì €ì¥</button>
  <button id="pdfBtn">ğŸ“„ PDF ì €ì¥</button>
  <button onclick="callAI('title')">ğŸ§  ì œëª© ì¶”ì²œ</button>
  <button onclick="callAI('outline')">ğŸ§­ ì†Œì œëª© ì¶”ì²œ</button>
  <button onclick="callAI('refine')">ğŸ“ ë¬¸ì¥ ë‹¤ë“¬ê¸°</button>
  <button onclick="triggerAnnotation()">ğŸ“ ì„ íƒ ì£¼ì„ ìƒì„±</button>
</div>

<div id="aiSuggestion">AI ì¶”ì²œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<h3>ğŸ“š ì €ì¥ëœ ì„¤êµ ëª©ë¡</h3>
<select id="filterCategory"><option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option></select>
<input type="date" id="filterDate" />
<div id="sermonList" style="max-height: 200px; overflow-y: auto; background:#222; color:#eee; padding:10px; border-radius:10px;"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDuF64w0S6ZcoXAuhtahlUAhCgAYnOFBXo",
    authDomain: "sermonnote-live.firebaseapp.com",
    projectId: "sermonnote-live",
    storageBucket: "sermonnote-live.appspot.com",
    messagingSenderId: "520754190508",
    appId: "1:520754190508:web:cc4271b1e96e0bed3ee709",
    measurementId: "G-CWDVF5K3HX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  auth.signInAnonymously().then(({ user }) => {
    currentUser = user;
    loadSermonList();
  });

  async function fetchAnnotation(text) {
    const display = document.getElementById("aiSuggestion");
    display.textContent = `"${text}" ì— ëŒ€í•œ ì£¼ì„ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...`;
    try {
      const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt: `ë‹¤ìŒ ì„±ê²½ ë‹¨ì–´ë‚˜ êµ¬ì ˆì— ëŒ€í•œ ì£¼ì„ì„ **í•œê¸€ë¡œ** ì‘ì„±í•´ì¤˜. KRV ì„±ê²½ì„ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•´ì¤˜:\n\n- ì›ì–´ í•´ì„ (íˆë¸Œë¦¬ì–´ ë˜ëŠ” í—¬ë¼ì–´)\n- ì‹ í•™ì  ì„¤ëª…\n- ì°¸ê³ ë¬¸í—Œ\n- ê´€ë ¨ ì„±ê²½ êµ¬ì ˆ\n\nğŸ“Œ ëŒ€ìƒ: "${text}"`
        })
      });
      const data = await res.json();
      display.textContent = data.result || "ì£¼ì„ ìƒì„± ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
    } catch (e) {
      display.textContent = "âŒ ì£¼ì„ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
      console.error(e);
    }
  }

  function triggerAnnotation() {
    const selected = window.getSelection().toString().trim();
    if (!selected) return alert("ë¨¼ì € ë‹¨ì–´ë‚˜ ë¬¸ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    fetchAnnotation(selected);
  }

  document.getElementById("saveBtn").addEventListener("click", async () => {
    const text = expositoryText.value.trim();
    const interpretation = expositoryInterpretation.value.trim();
    const application = expositoryApplication.value.trim();
    const date = document.getElementById("sermonDate").value;
    const category = document.getElementById("sermonCategory").value;
    if (!text || !interpretation || !application || !date || !category) {
      alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    try {
      await db.collection("expository_sermons").add({
        uid: currentUser.uid,
        text, interpretation, application, date, category,
        timestamp: new Date()
      });
      alert("âœ… ì €ì¥ ì™„ë£Œ!");
      loadSermonList();
    } catch (e) {
      console.error(e);
      alert("âŒ ì €ì¥ ì‹¤íŒ¨");
    }
  });

  document.getElementById("pdfBtn").addEventListener("click", () => {
    const doc = new jspdf.jsPDF();
    doc.setFontSize(12);
    doc.text("ğŸ“– ê°•í•´ì‹ ì„¤êµ", 10, 10);
    doc.text("ë³¸ë¬¸:", 10, 20);
    doc.text(expositoryText.value, 10, 30);
    doc.text("í•´ì„:", 10, 50);
    doc.text(expositoryInterpretation.value, 10, 60);
    doc.text("ì ìš©:", 10, 80);
    doc.text(expositoryApplication.value, 10, 90);
    doc.save("expository_sermon.pdf");
  });

  async function callAI(type) {
    const combined = `${expositoryText.value}\n\n${expositoryInterpretation.value}\n\n${expositoryApplication.value}`.trim();
    if (!combined) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    const promptType = {
      title: "ì´ ì„¤êµ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì œëª©ì„ ì¶”ì²œí•´ì¤˜.",
      outline: "ì´ ì„¤êµ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì†Œì œëª© 3ê°œë¥¼ ì¶”ì²œí•´ì¤˜.",
      refine: "ì´ ì„¤êµ ë‚´ìš©ì„ ë” ìì—°ìŠ¤ëŸ½ê²Œ ì •ë¦¬í•´ì¤˜."
    }[type];
    aiSuggestion.textContent = "AI ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    try {
      const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: `${promptType}\n\n${combined}` })
      });
      const data = await res.json();
      aiSuggestion.textContent = data.result || "ê²°ê³¼ ì—†ìŒ";
    } catch (e) {
      aiSuggestion.textContent = "AI ì˜¤ë¥˜ ë°œìƒ";
    }
  }

  async function loadSermonList() {
    if (!currentUser) return;
    const list = document.getElementById("sermonList");
    const filterCategory = document.getElementById("filterCategory").value;
    const filterDate = document.getElementById("filterDate").value;

    let query = db.collection("expository_sermons").where("uid", "==", currentUser.uid).orderBy("timestamp", "desc");
    if (filterCategory) query = query.where("category", "==", filterCategory);
    if (filterDate) query = query.where("date", "==", filterDate);

    const snapshot = await query.get();
    const categorySet = new Set();
    list.innerHTML = "";

    snapshot.forEach(doc => {
      const s = doc.data();
      categorySet.add(s.category);
      const div = document.createElement("div");
      div.textContent = `ğŸ“… ${s.date} | ğŸ“ ${s.category}`;
      div.onclick = () => {
        expositoryText.value = s.text;
        expositoryInterpretation.value = s.interpretation;
        expositoryApplication.value = s.application;
      };
      list.appendChild(div);
    });

    const catSel = document.getElementById("filterCategory");
    catSel.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
    categorySet.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSel.appendChild(opt);
    });
  }

  document.getElementById("filterCategory").addEventListener("change", loadSermonList);
  document.getElementById("filterDate").addEventListener("change", loadSermonList);
</script>

</body>
</html>
