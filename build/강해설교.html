<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Expository Sermon Writing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>/* 기존 스타일 생략 */</style>
</head>
<body>

<h2>✍ 강해식 설교 작성</h2>

<label>1. 본문</label>
<textarea id="expositoryText"></textarea>

<label>2. 해석 및 주석</label>
<textarea id="expositoryInterpretation"></textarea>

<label>3. 적용 및 결론</label>
<textarea id="expositoryApplication"></textarea>

<label>📅 날짜 <input type="date" id="sermonDate" /></label>
<label>📁 주제 <input type="text" id="sermonCategory" placeholder="예: 주일예배"/></label>

<div>
  <button id="saveBtn">💾 저장</button>
  <button id="pdfBtn">📄 PDF 저장</button>
  <button onclick="callAI('title')">🧠 제목 추천</button>
  <button onclick="callAI('outline')">🧭 소제목 추천</button>
  <button onclick="callAI('refine')">📝 문장 다듬기</button>
  <button onclick="triggerAnnotation()">📝 선택 주석 생성</button>
</div>

<div id="aiSuggestion">AI 추천 결과가 여기에 표시됩니다.</div>

<h3>📚 저장된 설교 목록</h3>
<select id="filterCategory"><option value="">카테고리 선택</option></select>
<input type="date" id="filterDate" />
<div id="sermonList" style="max-height: 200px; overflow-y: auto; background:#222; color:#eee; padding:10px; border-radius:10px;"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDuF64w0S6ZcoXAuhtahlUAhCgAYnOFBXo",
    authDomain: "sermonnote-live.firebaseapp.com",
    projectId: "sermonnote-live",
    storageBucket: "sermonnote-live.appspot.com",
    messagingSenderId: "520754190508",
    appId: "1:520754190508:web:cc4271b1e96e0bed3ee709",
    measurementId: "G-CWDVF5K3HX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  auth.signInAnonymously().then(({ user }) => {
    currentUser = user;
    loadSermonList();
  });

  async function fetchAnnotation(text) {
    const display = document.getElementById("aiSuggestion");
    display.textContent = `"${text}" 에 대한 주석을 생성 중입니다...`;
    try {
      const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt: `다음 성경 단어나 구절에 대한 주석을 **한글로** 작성해줘. KRV 성경을 기준으로 다음 항목을 포함해줘:\n\n- 원어 해석 (히브리어 또는 헬라어)\n- 신학적 설명\n- 참고문헌\n- 관련 성경 구절\n\n📌 대상: "${text}"`
        })
      });
      const data = await res.json();
      display.textContent = data.result || "주석 생성 결과가 없습니다.";
    } catch (e) {
      display.textContent = "❌ 주석 생성 중 오류 발생.";
      console.error(e);
    }
  }

  function triggerAnnotation() {
    const selected = window.getSelection().toString().trim();
    if (!selected) return alert("먼저 단어나 문장을 선택해주세요.");
    fetchAnnotation(selected);
  }

  document.getElementById("saveBtn").addEventListener("click", async () => {
    const text = expositoryText.value.trim();
    const interpretation = expositoryInterpretation.value.trim();
    const application = expositoryApplication.value.trim();
    const date = document.getElementById("sermonDate").value;
    const category = document.getElementById("sermonCategory").value;
    if (!text || !interpretation || !application || !date || !category) {
      alert('모든 항목을 입력해주세요.');
      return;
    }
    try {
      await db.collection("expository_sermons").add({
        uid: currentUser.uid,
        text, interpretation, application, date, category,
        timestamp: new Date()
      });
      alert("✅ 저장 완료!");
      loadSermonList();
    } catch (e) {
      console.error(e);
      alert("❌ 저장 실패");
    }
  });

  document.getElementById("pdfBtn").addEventListener("click", () => {
    const doc = new jspdf.jsPDF();
    doc.setFontSize(12);
    doc.text("📖 강해식 설교", 10, 10);
    doc.text("본문:", 10, 20);
    doc.text(expositoryText.value, 10, 30);
    doc.text("해석:", 10, 50);
    doc.text(expositoryInterpretation.value, 10, 60);
    doc.text("적용:", 10, 80);
    doc.text(expositoryApplication.value, 10, 90);
    doc.save("expository_sermon.pdf");
  });

  async function callAI(type) {
    const combined = `${expositoryText.value}\n\n${expositoryInterpretation.value}\n\n${expositoryApplication.value}`.trim();
    if (!combined) return alert("내용을 입력해주세요.");
    const promptType = {
      title: "이 설교 내용을 바탕으로 제목을 추천해줘.",
      outline: "이 설교 내용을 바탕으로 소제목 3개를 추천해줘.",
      refine: "이 설교 내용을 더 자연스럽게 정리해줘."
    }[type];
    aiSuggestion.textContent = "AI 추천을 불러오는 중...";
    try {
      const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: `${promptType}\n\n${combined}` })
      });
      const data = await res.json();
      aiSuggestion.textContent = data.result || "결과 없음";
    } catch (e) {
      aiSuggestion.textContent = "AI 오류 발생";
    }
  }

  async function loadSermonList() {
    if (!currentUser) return;
    const list = document.getElementById("sermonList");
    const filterCategory = document.getElementById("filterCategory").value;
    const filterDate = document.getElementById("filterDate").value;

    let query = db.collection("expository_sermons").where("uid", "==", currentUser.uid).orderBy("timestamp", "desc");
    if (filterCategory) query = query.where("category", "==", filterCategory);
    if (filterDate) query = query.where("date", "==", filterDate);

    const snapshot = await query.get();
    const categorySet = new Set();
    list.innerHTML = "";

    snapshot.forEach(doc => {
      const s = doc.data();
      categorySet.add(s.category);
      const div = document.createElement("div");
      div.textContent = `📅 ${s.date} | 📁 ${s.category}`;
      div.onclick = () => {
        expositoryText.value = s.text;
        expositoryInterpretation.value = s.interpretation;
        expositoryApplication.value = s.application;
      };
      list.appendChild(div);
    });

    const catSel = document.getElementById("filterCategory");
    catSel.innerHTML = '<option value="">카테고리 선택</option>';
    categorySet.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSel.appendChild(opt);
    });
  }

  document.getElementById("filterCategory").addEventListener("change", loadSermonList);
  document.getElementById("filterDate").addEventListener("change", loadSermonList);
</script>

</body>
</html>
