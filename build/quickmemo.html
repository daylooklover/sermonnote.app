<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í€µë©”ëª¨ ì„¤êµ ì‘ì„± í™”ë©´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* ê¸°ì¡´ CSS ë™ì¼ - ìƒëµ */
    #sermonList {
      margin-top: 20px;
      background: #2b2b3a;
      padding: 10px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      color: #fff;
    }
    #sermonList div {
      padding: 6px;
      border-bottom: 1px solid #444;
      cursor: pointer;
    }
    #sermonList div:hover {
      background: #3c3c4c;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- ì™¼ìª½ í€µë©”ëª¨ -->
  <div class="sidebar">
    <h2>âœ í€µë©”ëª¨</h2>
    <input type="text" id="quickmemoSearch" placeholder="í€µë©”ëª¨ ê²€ìƒ‰...">
    <div id="quickmemoList"></div>
    <button id="deleteAllBtn">ğŸ—‘ ëª¨ë‘ ì‚­ì œ</button>
    <div>
      <h3 style="margin-top:20px; color:#ffeb3b;">ğŸ“š ì €ì¥ëœ ì„¤êµ</h3>
      <select id="filterCategory"><option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option></select>
      <input type="date" id="filterDate" />
      <div id="sermonList"></div>
    </div>
  </div>

  <!-- ê°€ìš´ë° ì„¤êµ ì‘ì„± -->
  <div class="main-content">
    <label>ğŸ“† ì‘ì„±ì¼: <input type="date" id="sermonDate" /></label>
    <br/><label>ğŸ“ ì¹´í…Œê³ ë¦¬: <input type="text" id="sermonCategory" placeholder="ì˜ˆ: ì£¼ì¼ì˜ˆë°°"/></label>
    <textarea id="sermonContent" placeholder="ì„¤êµ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <div class="btn-row">
      <button id="startRecordBtn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
      <button id="stopRecordBtn" disabled>â–  ì¤‘ì§€</button>
      <button id="editBtn">ìˆ˜ì •</button>
      <button id="saveBtn">ì €ì¥</button>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ AI ì œì•ˆ + ê¸°ëŠ¥ ë²„íŠ¼ -->
  <div class="right-panel">
    <div class="ai-box">
      ğŸ¤– AI ì œì•ˆ:
      <div id="aiSuggestion">â€œë¯¿ìŒì€ ë°”ë¼ëŠ” ê²ƒë“¤ì˜ ì‹¤ìƒì´ìš”â€¦â€</div>
    </div>
    <div class="final-buttons">
      <button id="printBtn">ğŸ–¨ ì¸ì‡„</button>
      <button id="cloudSaveBtn">ğŸ’¾ ì €ì¥</button>
      <button id="sendTabletBtn">ğŸ“± íƒœë¸”ë¦¿ ì „ì†¡</button>
      <button id="pdfBtn">ğŸ“„ PDF ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDuF64w0S6ZcoXAuhtahlUAhCgAYnOFBXo",
    authDomain: "sermonnote-live.firebaseapp.com",
    projectId: "sermonnote-live",
    storageBucket: "sermonnote-live.firebasestorage.app",
    messagingSenderId: "520754190508",
    appId: "1:520754190508:web:cc4271b1e96e0bed3ee709",
    measurementId: "G-CWDVF5K3HX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  async function loadSermonList() {
    const listDiv = document.getElementById("sermonList");
    const filterDate = document.getElementById("filterDate").value;
    const filterCategory = document.getElementById("filterCategory").value;
    let query = db.collection("sermons").orderBy("timestamp", "desc");

    if (filterDate) query = query.where("date", "==", filterDate);
    if (filterCategory) query = query.where("category", "==", filterCategory);

    const snapshot = await query.get();
    const categorySet = new Set();
    listDiv.innerHTML = "";

    snapshot.forEach(doc => {
      const d = doc.data();
      categorySet.add(d.category);
      const div = document.createElement("div");
      div.textContent = `ğŸ“… ${d.date} | ğŸ“ ${d.category}`;
      div.onclick = () => {
        document.getElementById("sermonDate").value = d.date;
        document.getElementById("sermonCategory").value = d.category;
        document.getElementById("sermonContent").value = d.content;
      };
      listDiv.appendChild(div);
    });

    const categorySelect = document.getElementById("filterCategory");
    categorySelect.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
    categorySet.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }

  document.getElementById("cloudSaveBtn").addEventListener("click", async () => {
    const content = document.getElementById("sermonContent").value.trim();
    const date = document.getElementById("sermonDate").value;
    const category = document.getElementById("sermonCategory").value.trim();

    if (!content || !date || !category) {
      alert("ë‚ ì§œ, ì¹´í…Œê³ ë¦¬, ì„¤êµ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      await db.collection("sermons").add({ date, category, content, timestamp: new Date() });
      alert("ğŸ“¤ Firebaseì— ì €ì¥ ì™„ë£Œ!");
      loadSermonList();

// âœ… AIê°€ ì„¤êµë¥¼ êµ¬ì¡°í™”í•´ì„œ ì €ì¥í•˜ê¸° (ì œëª©, ì†Œì œëª©, ì •ë¦¬ëœ ë³¸ë¬¸ ìë™ ìƒì„±)
async function generateStructuredSermon() {
  const content = document.getElementById("sermonContent").value.trim();
  const date = document.getElementById("sermonDate").value;
  const category = document.getElementById("sermonCategory").value.trim();
  if (!content || !date || !category) return alert("ë‚ ì§œ, ì¹´í…Œê³ ë¦¬, ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

  const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: `ë‹¤ìŒ ì„¤êµ ë‚´ìš©ì„ êµ¬ì¡°í™”í•´ì„œ ì •ë¦¬í•´ì¤˜.

1. ì œëª©
2. ì†Œì œëª© 3ê°œ
3. ë³¸ë¬¸ ì •ë¦¬

ì„¤êµ ë‚´ìš©:
${content}`,
      role: "user"
    })
  });

  const data = await res.json();
  if (!data.result) return alert("AI êµ¬ì¡°í™” ì‹¤íŒ¨");

  const structured = data.result;
  await db.collection("structured_sermons").add({
    date,
    category,
    structured,
    original: content,
    timestamp: new Date()
  });

  alert("ğŸ§  AI êµ¬ì¡°í™” ì„¤êµê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
} 

const structuredBtn = document.createElement("button");
structuredBtn.textContent = "ğŸ“š ì„¤êµ AI êµ¬ì¡°í™” ì €ì¥";
structuredBtn.onclick = generateStructuredSermon;
structuredBtn.style.marginTop = "10px";
document.querySelector(".final-buttons").appendChild(structuredBtn);

// ğŸ”¥ AI ê¸°ëŠ¥ ì—°ë™: GPT API í˜¸ì¶œ (1. ë³¸ë¬¸ ê¸°ë°˜ ì¶”ì²œ, 2. ì œëª© ìƒì„±, 4. ìŒì„±ì…ë ¥ ìë™ ì •ë¦¬)
async function callAI(type) {
  const content = document.getElementById("sermonContent").value.trim();
  if (!content) return alert("ì„¤êµ ë³¸ë¬¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");

  const systemPrompt = {
    title: "ë³¸ë¬¸ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤êµ ì œëª©ì„ ì¶”ì²œí•´ì¤˜.",
    outline: "ë³¸ë¬¸ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì†Œì œëª© 3ê°œë¥¼ ì œì•ˆí•´ì¤˜.",
    refine: "ì´ ì„¤êµ ë³¸ë¬¸ì„ ë” ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ë“¬ì–´ì¤˜."
  }[type];

  const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: `${systemPrompt}

${content}`,
      role: "user"
    })
  });

  const data = await res.json();
  if (data.result) {
    document.getElementById("aiSuggestion").textContent = data.result;
  } else {
    alert("AI ì‘ë‹µ ì‹¤íŒ¨");
  }
}

// AI ë²„íŠ¼ í´ë¦­ ì‹œ AI í˜¸ì¶œí•˜ë„ë¡ ì¶”ê°€ ë²„íŠ¼ ì—°ê²° ì˜ˆì •
const aiBox = document.querySelector(".ai-box");
const btns = document.createElement("div");
btns.innerHTML = `
  <button onclick="callAI('title')">ğŸ§  ì œëª© ì¶”ì²œ</button>
  <button onclick="callAI('outline')">ğŸ§­ ì†Œì œëª© ì¶”ì²œ</button>
  <button onclick="callAI('refine')">ğŸ“ ë¬¸ì¥ ë‹¤ë“¬ê¸°</button>
`;
btns.style.marginTop = '10px';
aiBox.appendChild(btns);
    } catch (e) {
      console.error("Firebase ì €ì¥ ì˜¤ë¥˜", e);
      alert("âŒ ì €ì¥ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸");
    }
  });

  document.getElementById("pdfBtn").addEventListener("click", () => {
    const content = document.getElementById("sermonContent").value;
    const date = document.getElementById("sermonDate").value;
    const category = document.getElementById("sermonCategory").value;
    const doc = new jspdf.jsPDF();
    doc.setFontSize(12);
    doc.text(`ğŸ“… ë‚ ì§œ: ${date}`, 10, 10);
    doc.text(`ğŸ“ ì¹´í…Œê³ ë¦¬: ${category}`, 10, 20);
    doc.text("\në‚´ìš©:\n" + content, 10, 30);
    doc.save("sermon_note.pdf");
  });

  document.getElementById("printBtn").addEventListener("click", () => window.print());
  document.getElementById("sendTabletBtn").addEventListener("click", () => {
    alert("ğŸ“± íƒœë¸”ë¦¿ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)");
  });
  document.getElementById("filterCategory").addEventListener("change", loadSermonList);
  document.getElementById("filterDate").addEventListener("change", loadSermonList);

  loadSermonList();
</script>

</body>
</html>
