<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>퀵메모 설교 작성 화면</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* 기존 CSS 동일 - 생략 */
    #sermonList {
      margin-top: 20px;
      background: #2b2b3a;
      padding: 10px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      color: #fff;
    }
    #sermonList div {
      padding: 6px;
      border-bottom: 1px solid #444;
      cursor: pointer;
    }
    #sermonList div:hover {
      background: #3c3c4c;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- 왼쪽 퀵메모 -->
  <div class="sidebar">
    <h2>✍ 퀵메모</h2>
    <input type="text" id="quickmemoSearch" placeholder="퀵메모 검색...">
    <div id="quickmemoList"></div>
    <button id="deleteAllBtn">🗑 모두 삭제</button>
    <div>
      <h3 style="margin-top:20px; color:#ffeb3b;">📚 저장된 설교</h3>
      <select id="filterCategory"><option value="">카테고리 선택</option></select>
      <input type="date" id="filterDate" />
      <div id="sermonList"></div>
    </div>
  </div>

  <!-- 가운데 설교 작성 -->
  <div class="main-content">
    <label>📆 작성일: <input type="date" id="sermonDate" /></label>
    <br/><label>📁 카테고리: <input type="text" id="sermonCategory" placeholder="예: 주일예배"/></label>
    <textarea id="sermonContent" placeholder="설교 내용을 입력하세요..."></textarea>
    <div class="btn-row">
      <button id="startRecordBtn">🎙 녹음 시작</button>
      <button id="stopRecordBtn" disabled>■ 중지</button>
      <button id="editBtn">수정</button>
      <button id="saveBtn">저장</button>
    </div>
  </div>

  <!-- 오른쪽 AI 제안 + 기능 버튼 -->
  <div class="right-panel">
    <div class="ai-box">
      🤖 AI 제안:
      <div id="aiSuggestion">“믿음은 바라는 것들의 실상이요…”</div>
    </div>
    <div class="final-buttons">
      <button id="printBtn">🖨 인쇄</button>
      <button id="cloudSaveBtn">💾 저장</button>
      <button id="sendTabletBtn">📱 태블릿 전송</button>
      <button id="pdfBtn">📄 PDF 저장</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDuF64w0S6ZcoXAuhtahlUAhCgAYnOFBXo",
    authDomain: "sermonnote-live.firebaseapp.com",
    projectId: "sermonnote-live",
    storageBucket: "sermonnote-live.firebasestorage.app",
    messagingSenderId: "520754190508",
    appId: "1:520754190508:web:cc4271b1e96e0bed3ee709",
    measurementId: "G-CWDVF5K3HX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  async function loadSermonList() {
    const listDiv = document.getElementById("sermonList");
    const filterDate = document.getElementById("filterDate").value;
    const filterCategory = document.getElementById("filterCategory").value;
    let query = db.collection("sermons").orderBy("timestamp", "desc");

    if (filterDate) query = query.where("date", "==", filterDate);
    if (filterCategory) query = query.where("category", "==", filterCategory);

    const snapshot = await query.get();
    const categorySet = new Set();
    listDiv.innerHTML = "";

    snapshot.forEach(doc => {
      const d = doc.data();
      categorySet.add(d.category);
      const div = document.createElement("div");
      div.textContent = `📅 ${d.date} | 📁 ${d.category}`;
      div.onclick = () => {
        document.getElementById("sermonDate").value = d.date;
        document.getElementById("sermonCategory").value = d.category;
        document.getElementById("sermonContent").value = d.content;
      };
      listDiv.appendChild(div);
    });

    const categorySelect = document.getElementById("filterCategory");
    categorySelect.innerHTML = '<option value="">카테고리 선택</option>';
    categorySet.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }

  document.getElementById("cloudSaveBtn").addEventListener("click", async () => {
    const content = document.getElementById("sermonContent").value.trim();
    const date = document.getElementById("sermonDate").value;
    const category = document.getElementById("sermonCategory").value.trim();

    if (!content || !date || !category) {
      alert("날짜, 카테고리, 설교 내용을 모두 입력해주세요.");
      return;
    }

    try {
      await db.collection("sermons").add({ date, category, content, timestamp: new Date() });
      alert("📤 Firebase에 저장 완료!");
      loadSermonList();

// ✅ AI가 설교를 구조화해서 저장하기 (제목, 소제목, 정리된 본문 자동 생성)
async function generateStructuredSermon() {
  const content = document.getElementById("sermonContent").value.trim();
  const date = document.getElementById("sermonDate").value;
  const category = document.getElementById("sermonCategory").value.trim();
  if (!content || !date || !category) return alert("날짜, 카테고리, 본문을 입력해주세요.");

  const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: `다음 설교 내용을 구조화해서 정리해줘.

1. 제목
2. 소제목 3개
3. 본문 정리

설교 내용:
${content}`,
      role: "user"
    })
  });

  const data = await res.json();
  if (!data.result) return alert("AI 구조화 실패");

  const structured = data.result;
  await db.collection("structured_sermons").add({
    date,
    category,
    structured,
    original: content,
    timestamp: new Date()
  });

  alert("🧠 AI 구조화 설교가 저장되었습니다.");
} 

const structuredBtn = document.createElement("button");
structuredBtn.textContent = "📚 설교 AI 구조화 저장";
structuredBtn.onclick = generateStructuredSermon;
structuredBtn.style.marginTop = "10px";
document.querySelector(".final-buttons").appendChild(structuredBtn);

// 🔥 AI 기능 연동: GPT API 호출 (1. 본문 기반 추천, 2. 제목 생성, 4. 음성입력 자동 정리)
async function callAI(type) {
  const content = document.getElementById("sermonContent").value.trim();
  if (!content) return alert("설교 본문을 먼저 입력해주세요.");

  const systemPrompt = {
    title: "본문을 기반으로 설교 제목을 추천해줘.",
    outline: "본문 내용을 기반으로 소제목 3개를 제안해줘.",
    refine: "이 설교 본문을 더 자연스럽게 다듬어줘."
  }[type];

  const res = await fetch("https://us-central1-sermonnote-live.cloudfunctions.net/api", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: `${systemPrompt}

${content}`,
      role: "user"
    })
  });

  const data = await res.json();
  if (data.result) {
    document.getElementById("aiSuggestion").textContent = data.result;
  } else {
    alert("AI 응답 실패");
  }
}

// AI 버튼 클릭 시 AI 호출하도록 추가 버튼 연결 예정
const aiBox = document.querySelector(".ai-box");
const btns = document.createElement("div");
btns.innerHTML = `
  <button onclick="callAI('title')">🧠 제목 추천</button>
  <button onclick="callAI('outline')">🧭 소제목 추천</button>
  <button onclick="callAI('refine')">📝 문장 다듬기</button>
`;
btns.style.marginTop = '10px';
aiBox.appendChild(btns);
    } catch (e) {
      console.error("Firebase 저장 오류", e);
      alert("❌ 저장 실패: 콘솔 확인");
    }
  });

  document.getElementById("pdfBtn").addEventListener("click", () => {
    const content = document.getElementById("sermonContent").value;
    const date = document.getElementById("sermonDate").value;
    const category = document.getElementById("sermonCategory").value;
    const doc = new jspdf.jsPDF();
    doc.setFontSize(12);
    doc.text(`📅 날짜: ${date}`, 10, 10);
    doc.text(`📁 카테고리: ${category}`, 10, 20);
    doc.text("\n내용:\n" + content, 10, 30);
    doc.save("sermon_note.pdf");
  });

  document.getElementById("printBtn").addEventListener("click", () => window.print());
  document.getElementById("sendTabletBtn").addEventListener("click", () => {
    alert("📱 태블릿으로 전송되었습니다. (시뮬레이션)");
  });
  document.getElementById("filterCategory").addEventListener("change", loadSermonList);
  document.getElementById("filterDate").addEventListener("change", loadSermonList);

  loadSermonList();
</script>

</body>
</html>
