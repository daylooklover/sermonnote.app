<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°•í•´ ì„¤êµ ì‘ì„±ê¸° (ëª©íšŒììš©)</title>
  <style>
    body {
      font-family: 'Nanum Gothic', sans-serif;
      background: linear-gradient(135deg, #1c1c2b, #28313b);
      margin: 0;
      color: #f0e6d2;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* ìƒë‹¨ ì •ë ¬ */
      min-height: 100vh;
      padding: 40px 0; /* ìƒí•˜ íŒ¨ë”© ì¶”ê°€ */
      box-sizing: border-box;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 900px;
      width: 95%;
      box-sizing: border-box;
    }
    h2 {
      color: #222;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.2rem;
    }
    label {
      color: #222;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      margin-top: 15px;
      font-size: 1.1rem;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      box-sizing: border-box;
      resize: vertical;
      background-color: #f9f9f9;
      color: #222;
    }
    textarea {
      line-height: 30px;
      background: linear-gradient(to bottom, #fff 29px, #f0f0f0 30px),
                  url('https://www.transparenttextures.com/patterns/lined-paper.png');
      background-size: 100% 30px;
      background-repeat: repeat-y;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
      min-height: 150px; /* ê¸°ë³¸ ë†’ì´ ì„¤ì • */
    }
    .output-box {
      background: #eee;
      color: #222;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      white-space: pre-wrap;
      font-size: 0.95rem;
      border: 1px solid #ddd;
      min-height: 40px; /* ê¸°ë³¸ ë†’ì´ */
      display: flex;
      align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
      word-break: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
    }
    #originalLanguageOutput {
      background: #222;
      color: #ffeb3b; /* ê°•ì¡°ìƒ‰ */
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
      font-size: 0.95rem;
      line-height: 1.5;
      text-align: left;
      white-space: pre-wrap;
      box-shadow: inset 0 0 15px rgba(255, 235, 59, 0.2);
      min-height: 40px;
    }

    .button-group {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      background: #ffea00;
      color: #222;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      background: #fff176;
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    }
    button:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    #micBtn {
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
      vertical-align: middle;
      background: #ff5252;
      color: white;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-left: 10px;
      box-shadow: 0 4px 8px rgba(255, 82, 82, 0.4);
    }
    #micBtn.active {
      background: #e00000;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(244,67,54,0.7); }
      70%  { box-shadow: 0 0 0 15px rgba(244,67,54,0); }
      100% { box-shadow: 0 0 0 0 rgba(244,67,54,0); }
    }
    .ai-suggestion-box {
      /* ê¸°ì¡´ ë°°ê²½ìƒ‰ ëŒ€ì‹  ë…¸íŠ¸ ì´ë¯¸ì§€ ë°°ê²½ ì ìš© */
      background: linear-gradient(to bottom, #fff 29px, #f0f0f0 30px),
                  url('https://www.transparenttextures.com/patterns/lined-paper.png');
      background-size: 100% 30px;
      background-repeat: repeat-y;
      color: #333; /* ë…¸íŠ¸ ë°°ê²½ì— ë§ì¶° í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ */
      padding: 16px;
      border-radius: 12px;
      min-height: 120px;
      white-space: pre-wrap;
      box-shadow: 0 0 10px rgba(0,0,0,0.1); /* ê·¸ë¦¼ìë„ ë°ê²Œ ë³€ê²½ */
      font-size: 1rem;
      line-height: 1.6;
      margin-top: 30px;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>ğŸ“– ê°•í•´ ì„¤êµ ì‘ì„±ê¸° (ëª©íšŒììš©)</h2>

  <label for="scriptureInput">1. ì„±ê²½ ë³¸ë¬¸</label>
  <input type="text" id="scriptureInput" placeholder="ì˜ˆ: ìš”í•œë³µìŒ 3ì¥ 16ì ˆ ë˜ëŠ” ì°½ì„¸ê¸° 1ì¥ 1-5ì ˆ">
  <div class="button-group">
    <button id="fetchVerseBtn">ì„±ê²½ ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸°</button>
    <button id="fetchOriginalLanguageBtn">ì›ì–´ í†µì°°</button>
  </div>
  <div id="bibleVerseOutput" class="output-box">ğŸ“– ì„±ê²½ êµ¬ì ˆ ë³¸ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
  <div id="originalLanguageOutput" class="output-box">ğŸ“œ ì›ì–´ í†µì°°ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>

  <label for="explanationTextarea">2. ë³¸ë¬¸ í•´ì„ ë° ì£¼ì„ (AI ì¶”ì²œ í¬í•¨)</label>
  <textarea id="explanationTextarea" placeholder="ë³¸ë¬¸ì— ëŒ€í•œ í•´ì„ê³¼ ì£¼ì„ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, AI ì£¼ì„ ì¶”ì²œ ë²„íŠ¼ì„ í™œìš©í•˜ì„¸ìš”."></textarea>
  <div class="button-group">
    <button id="aiCommentaryBtn">AI ì£¼ì„ ì¶”ì²œ</button>
  </div>
  <div id="aiCommentarySuggestion" class="ai-suggestion-box">ğŸ§  AI ì£¼ì„ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>

  <label for="applicationTextarea">3. ì ìš© ë° ê²°ë¡ </label>
  <textarea id="applicationTextarea" placeholder="ì„¤êµì˜ ì ìš©ì ê³¼ ê²°ë¡ ì„ ì •ë¦¬í•˜ì„¸ìš”."></textarea>

  <div class="button-group">
    <button id="generateFullSermonBtn">âœ¨ ì „ì²´ ì„¤êµ ê°œìš”/ë©”ì‹œì§€ AI ì¶”ì²œ</button>
    <button id="savePDFBtn">ğŸ“„ PDF ì €ì¥</button>
    <button onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
    <button id="micBtn">ğŸ¤ ìŒì„± ì…ë ¥</button>
  </div>

  <div id="aiFullSermonSuggestion" class="ai-suggestion-box">ğŸ’¡ AI ì„¤êµ ê°œìš”/ë©”ì‹œì§€ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const backendUrl = 'http://localhost:3000'; // ë°±ì—”ë“œ ì„œë²„ ì£¼ì†Œ

// --- DOM ìš”ì†Œ ì°¸ì¡° ---
const scriptureInput = document.getElementById('scriptureInput');
const bibleVerseOutput = document.getElementById('bibleVerseOutput');
const originalLanguageOutput = document.getElementById('originalLanguageOutput');
const explanationTextarea = document.getElementById('explanationTextarea');
const aiCommentarySuggestion = document.getElementById('aiCommentarySuggestion');
const applicationTextarea = document.getElementById('applicationTextarea');
const aiFullSermonSuggestion = document.getElementById('aiFullSermonSuggestion');

const fetchVerseBtn = document.getElementById('fetchVerseBtn');
const fetchOriginalLanguageBtn = document.getElementById('fetchOriginalLanguageBtn');
const aiCommentaryBtn = document.getElementById('aiCommentaryBtn');
const generateFullSermonBtn = document.getElementById('generateFullSermonBtn');
const savePDFBtn = document.getElementById('savePDFBtn');
const micBtn = document.getElementById('micBtn');

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

// ëª¨ë“  ë²„íŠ¼ ë° ì…ë ¥ í•„ë“œ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
function setUIState(disabled) {
    const interactiveElements = [
        scriptureInput, fetchVerseBtn, fetchOriginalLanguageBtn,
        explanationTextarea, aiCommentaryBtn, applicationTextarea,
        generateFullSermonBtn, savePDFBtn, micBtn
    ];
    interactiveElements.forEach(el => el.disabled = disabled);
}

// ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ í‘œì‹œ (alert ëŒ€ì²´)
function displayMessage(targetElement, message, type = 'info') {
    targetElement.textContent = message;
    if (type === 'info') {
        targetElement.style.backgroundColor = '#f5f5f5'; /* ë…¸íŠ¸ ë°°ê²½ì— ë§ê²Œ ë³€ê²½ */
        targetElement.style.color = '#333';
    } else if (type === 'loading') {
        targetElement.style.backgroundColor = '#e0f2f7'; /* Light blue for loading */
        targetElement.style.color = '#000';
    } else if (type === 'error') {
        targetElement.style.backgroundColor = '#ffebee'; /* Light red for error */
        targetElement.style.color = '#d32f2f';
    } else if (type === 'warning') {
        targetElement.style.backgroundColor = '#fff3e0'; /* Light orange for warning */
        targetElement.style.color = '#e65100';
    }
}

// --- API í˜¸ì¶œ í•¨ìˆ˜ ---

// ë°±ì—”ë“œë¥¼ í†µí•´ AIì™€ í†µì‹ í•˜ëŠ” ì œë„ˆë¦­ í•¨ìˆ˜
async function callBackendAI(endpoint, prompt, systemPrompt, bibleReference = '') {
    setUIState(true); // UI ë¹„í™œì„±í™”
    try {
        const response = await fetch(`${backendUrl}${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, systemPrompt, bibleReference })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || response.statusText);
        }

        const data = await response.json();
        return data.content || data.insight; // ì‘ë‹µ í˜•ì‹ì— ë”°ë¼ content ë˜ëŠ” insight ë°˜í™˜
    } catch (error) {
        console.error(`ë°±ì—”ë“œ AI í˜¸ì¶œ ì˜¤ë¥˜ (${endpoint}):`, error);
        throw error; // ì˜¤ë¥˜ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ í˜¸ì¶œí•œ ê³³ì—ì„œ ì²˜ë¦¬
    } finally {
        setUIState(false); // UI í™œì„±í™”
    }
}

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

// ì„±ê²½ ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
fetchVerseBtn.addEventListener('click', async () => {
    const reference = scriptureInput.value.trim();
    if (!reference) {
        displayMessage(bibleVerseOutput, 'â— ì„±ê²½ êµ¬ì ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    displayMessage(bibleVerseOutput, 'ğŸ“– ì„±ê²½ êµ¬ì ˆ ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');
    setUIState(true);
    try {
        const response = await fetch(`${backendUrl}/api/bible-verse?reference=${encodeURIComponent(reference)}&translation=kor`);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || response.statusText);
        }
        const data = await response.json();
        displayMessage(bibleVerseOutput, data.text || 'ğŸ“• êµ¬ì ˆ ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } catch (error) {
        displayMessage(bibleVerseOutput, 'ğŸ“• ì„±ê²½ êµ¬ì ˆ ë¡œë”© ì˜¤ë¥˜: ' + error.message, 'error');
    } finally {
        setUIState(false);
    }
});

// ì›ì–´ í†µì°° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
fetchOriginalLanguageBtn.addEventListener('click', async () => {
    const reference = scriptureInput.value.trim();
    if (!reference) {
        displayMessage(originalLanguageOutput, 'â— ì›ì–´ í†µì°°ì„ ë³´ë ¤ë©´ ì„±ê²½ êµ¬ì ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    displayMessage(originalLanguageOutput, 'ğŸ“œ AIê°€ ì›ì–´ í†µì°°ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...', 'loading');
    
    try {
        // ë°±ì—”ë“œì˜ /api/original-language-insight ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
        const response = await fetch(`${backendUrl}/api/original-language-insight`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bibleReference: reference })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || response.statusText);
        }

        const data = await response.json();
        displayMessage(originalLanguageOutput, data.insight || 'ğŸ“œ ì›ì–´ í†µì°°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } catch (error) {
        displayMessage(originalLanguageOutput, 'âŒ ì›ì–´ í†µì°° ì˜¤ë¥˜: ' + error.message, 'error');
    }
});


// AI ì£¼ì„ ì¶”ì²œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
aiCommentaryBtn.addEventListener('click', async () => {
    const scripture = scriptureInput.value.trim();
    const currentExplanation = explanationTextarea.value.trim();

    if (!scripture && !currentExplanation) {
        displayMessage(aiCommentarySuggestion, 'â— ì£¼ì„ ì¶”ì²œì„ ë°›ìœ¼ë ¤ë©´ ì„±ê²½ êµ¬ì ˆì´ë‚˜ í˜„ì¬ í•´ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    displayMessage(aiCommentarySuggestion, 'ğŸ§  AIê°€ ì£¼ì„ì„ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...', 'loading');
    
    const prompt = `ì„±ê²½ êµ¬ì ˆ: ${scripture}\ní˜„ì¬ í•´ì„: ${currentExplanation}\nìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì´ êµ¬ì ˆì— ëŒ€í•œ ê¹Šì´ ìˆëŠ” ì£¼ì„(ë§ì”€ì˜ ë°°ê²½, ì‹ í•™ì  ì˜ë¯¸, í˜„ëŒ€ì  ì ìš©ì  ë“±)ì„ 200ë‹¨ì–´ ë‚´ì™¸ë¡œ ì‘ì„±í•´ì¤˜.`;
    const systemPrompt = "ë‹¹ì‹ ì€ ì„±ê²½ì  ë°°ê²½ê³¼ ì‹ í•™ì  í†µì°°ì„ ê°€ì§„ AI ì£¼ì„ê°€ì…ë‹ˆë‹¤. ëª©íšŒìë“¤ì´ ì„¤êµë¥¼ í’ì„±í•˜ê²Œ í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ì „ë¬¸ì ì¸ ì£¼ì„ì„ ì œê³µí•©ë‹ˆë‹¤.";

    try {
        const result = await callBackendAI('/api/ai-process', prompt, systemPrompt, scripture);
        displayMessage(aiCommentarySuggestion, result);
        // ìƒì„±ëœ ì£¼ì„ì„ í•´ì„/ì£¼ì„ ì¹¸ì— ì¶”ê°€í• ì§€ ë¬¼ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // if (confirm('ìƒì„±ëœ ì£¼ì„ì„ ë³¸ë¬¸ í•´ì„ ì¹¸ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        //     explanationTextarea.value += '\n\n' + result;
        // }
    } catch (error) {
        displayMessage(aiCommentarySuggestion, 'âŒ AI ì£¼ì„ ì¶”ì²œ ì˜¤ë¥˜: ' + error.message, 'error');
    }
});


// ì „ì²´ ì„¤êµ ê°œìš”/ë©”ì‹œì§€ AI ì¶”ì²œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
generateFullSermonBtn.addEventListener('click', async () => {
    const scripture = scriptureInput.value.trim();
    const explanation = explanationTextarea.value.trim();
    const application = applicationTextarea.value.trim();

    if (!scripture && !explanation && !application) {
        displayMessage(aiFullSermonSuggestion, 'â— ì„¤êµ ê°œìš” ì¶”ì²œì„ ë°›ìœ¼ë ¤ë©´ ì„±ê²½ êµ¬ì ˆ, í•´ì„, ì ìš© ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }

    displayMessage(aiFullSermonSuggestion, 'âœ¨ AIê°€ ì „ì²´ ì„¤êµ ê°œìš”/ë©”ì‹œì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...', 'loading');

    const prompt = `ğŸ“– ë³¸ë¬¸: ${scripture || 'ì—†ìŒ'}\nğŸ§  í•´ì„ ë° ì£¼ì„: ${explanation || 'ì—†ìŒ'}\nğŸ™ ì ìš© ë° ê²°ë¡ : ${application || 'ì—†ìŒ'}\nìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì „ì²´ ì„¤êµ ê°œìš”(ì„œë¡ , ë³¸ë¡ (ì†Œì£¼ì œ 2~3ê°œ), ê²°ë¡  í¬í•¨)ì™€ í•µì‹¬ ì„±ê²½ì  ë©”ì‹œì§€ë¥¼ í’ì„±í•˜ê²Œ ì •ë¦¬í•´ì¤˜.`;
    const systemPrompt = 'ë‹¹ì‹ ì€ ì„±ê²½ ë³¸ë¬¸ê³¼ ì ìš© ì¤‘ì‹¬ì˜ ê°•í•´ ì„¤êµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ëª©íšŒìë¥¼ ë•ëŠ” ëª…í™•í•˜ê³  ê°ë™ì ì¸ ì„¤êµ ê°œìš”ì™€ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.';

    try {
        const result = await callBackendAI('/api/ai-process', prompt, systemPrompt, scripture);
        displayMessage(aiFullSermonSuggestion, result);
    } catch (error) {
        displayMessage(aiFullSermonSuggestion, 'âŒ AI ì„¤êµ ê°œìš” ì¶”ì²œ ì˜¤ë¥˜: ' + error.message, 'error');
    }
});


// PDF ì €ì¥ ê¸°ëŠ¥
savePDFBtn.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const scriptureText = scriptureInput.value.trim();
    const bibleVerseText = bibleVerseOutput.textContent.trim();
    const originalLanguageText = originalLanguageOutput.textContent.trim();
    const explanationText = explanationTextarea.value.trim();
    const aiCommentaryText = aiCommentarySuggestion.textContent.trim();
    const applicationText = applicationTextarea.value.trim();
    const aiFullSermonText = aiFullSermonSuggestion.textContent.trim();
    
    // ìœ íš¨í•œ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸
    if (!scriptureText && !explanationText && !applicationText && 
        !aiCommentaryText.includes('AI ì£¼ì„ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤') && 
        !aiFullSermonText.includes('AI ì„¤êµ ê°œìš”/ë©”ì‹œì§€ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤')) {
        displayMessage(aiFullSermonSuggestion, "â— ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.", 'warning'); // ì„ì‹œ ë©”ì‹œì§€ í‘œì‹œ
        return;
    }

    let content = ``;
    if (scriptureText) content += `ğŸ“– ì„±ê²½ ë³¸ë¬¸:\n${scriptureText}\n\n`;
    if (bibleVerseText && !bibleVerseText.includes('ì„±ê²½ êµ¬ì ˆ ë³¸ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤') && !bibleVerseText.includes('êµ¬ì ˆ ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') && !bibleVerseText.includes('ë¡œë”© ì˜¤ë¥˜')) {
        content += `(ë³¸ë¬¸ ë‚´ìš©: ${bibleVerseText})\n\n`;
    }
    if (originalLanguageText && !originalLanguageText.includes('ì›ì–´ í†µì°°ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤') && !originalLanguageText.includes('ì›ì–´ í†µì°°ì„ ë³´ë ¤ë©´ ì„±ê²½ êµ¬ì ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”') && !originalLanguageText.includes('ì›ì–´ í†µì°° ì˜¤ë¥˜')) {
        content += `  ì›ì–´ í†µì°°:\n${originalLanguageText}\n\n`;
    }
    content += `--- í•´ì„ ë° ì£¼ì„ ---\n`;
    if (explanationText) content += `${explanationText}\n`;
    if (aiCommentaryText && !aiCommentaryText.includes('AI ì£¼ì„ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤') && !aiCommentaryText.includes('ì£¼ì„ ì¶”ì²œì„ ë°›ìœ¼ë ¤ë©´') && !aiCommentaryText.includes('ì£¼ì„ ì¶”ì²œ ì˜¤ë¥˜')) {
        content += `ğŸ§  AI ì£¼ì„ ì¶”ì²œ:\n${aiCommentaryText}\n\n`;
    } else if (!explanationText) {
        content += `(ì£¼ì„ ë‚´ìš© ì—†ìŒ)\n\n`;
    }
    
    content += `--- ì ìš© ë° ê²°ë¡  ---\n`;
    if (applicationText) content += `${applicationText}\n`;
    if (aiFullSermonText && !aiFullSermonText.includes('AI ì„¤êµ ê°œìš”/ë©”ì‹œì§€ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤') && !aiFullSermonText.includes('ì„¤êµ ê°œìš” ì¶”ì²œì„ ë°›ìœ¼ë ¤ë©´') && !aiFullSermonText.includes('ì„¤êµ ê°œìš” ì¶”ì²œ ì˜¤ë¥˜')) {
        content += `âœ¨ AI ì„¤êµ ê°œìš”/ë©”ì‹œì§€ ì¶”ì²œ:\n${aiFullSermonText}\n\n`;
    } else if (!applicationText) {
        content += `(ì ìš© ë° ê²°ë¡  ë‚´ìš© ì—†ìŒ)\n\n`;
    }


    // í•œê¸€ ì§€ì›ì„ ìœ„í•´ì„œëŠ” jspdf-autotableê³¼ ì»¤ìŠ¤í…€ í°íŠ¸ ë¡œë”© í•„ìš”
    // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ í°íŠ¸ ì‚¬ìš© (í•œê¸€ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ)
    // doc.addFont('NanumGothic-Regular.ttf', 'NanumGothic', 'normal');
    // doc.setFont('NanumGothic');

    const lines = doc.splitTextToSize(content, 180); // 180mm ë„ˆë¹„ì— ë§ì¶° í…ìŠ¤íŠ¸ ë¶„í• 
    let y = 10;
    const lineHeight = 7;

    lines.forEach(line => {
        if (y > 280) { // í˜ì´ì§€ ëì— ë„ë‹¬í•˜ë©´ ìƒˆ í˜ì´ì§€ ì¶”ê°€
            doc.addPage();
            y = 10;
        }
        doc.text(line, 10, y);
        y += lineHeight;
    });

    doc.save('ê°•í•´ì„¤êµ_ì‘ì„±ê¸°.pdf');
    displayMessage(aiFullSermonSuggestion, "âœ… ì„¤êµë¬¸ì´ PDFë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
});


// ğŸ¤ ìŒì„± ì…ë ¥ ì‹œì‘ í•¨ìˆ˜
function startMic() {
    const focusedElement = document.activeElement; // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œ
    
    // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ(textarea ë˜ëŠ” input[type="text"])ì—ë§Œ ì ìš©
    if (focusedElement && (focusedElement.tagName === 'TEXTAREA' || (focusedElement.tagName === 'INPUT' && focusedElement.type === 'text'))) {
        if (!('webkitSpeechRecognition' in window)) {
            displayMessage(aiFullSermonSuggestion, "âš ï¸ í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ìŒì„± ì…ë ¥ì´ ì§€ì›ë©ë‹ˆë‹¤.", 'warning');
            return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •

        recognition.onstart = () => {
            micBtn.classList.add('active');
            displayMessage(aiFullSermonSuggestion, "ìŒì„± ì…ë ¥ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë§ì”€í•˜ì„¸ìš”...", 'info');
        };
        recognition.onend = () => {
            micBtn.classList.remove('active');
            displayMessage(aiFullSermonSuggestion, "ìŒì„± ì…ë ¥ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
        };
        recognition.onerror = (event) => {
            displayMessage(aiFullSermonSuggestion, "ìŒì„± ì¸ì‹ ì˜¤ë¥˜: " + event.error, 'error');
            console.error("Speech Recognition Error:", event.error);
            micBtn.classList.remove('active');
        };
        recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            focusedElement.value += "\nâ€” " + text; // í˜„ì¬ í¬ì»¤ìŠ¤ëœ ìš”ì†Œì— í…ìŠ¤íŠ¸ ì¶”ê°€
        };
        
        recognition.start();
    } else {
        displayMessage(aiFullSermonSuggestion, "ìŒì„± ì…ë ¥ì„ ì‹œì‘í•˜ë ¤ë©´ í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì— ì»¤ì„œë¥¼ ë‘ì„¸ìš”.", 'warning');
    }
}

// ìŒì„± ì…ë ¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
micBtn.addEventListener('click', startMic);

// ì´ˆê¸° ë¡œë”© ì‹œ í”Œë ˆì´ìŠ¤í™€ë” ì„¤ì •
window.onload = () => {
    displayMessage(bibleVerseOutput, 'ğŸ“– ì„±ê²½ êµ¬ì ˆ ë³¸ë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤', 'info');
    displayMessage(originalLanguageOutput, 'ğŸ“œ ì›ì–´ í†µì°°ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤', 'info');
    displayMessage(aiCommentarySuggestion, 'ğŸ§  AI ì£¼ì„ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤', 'info');
    displayMessage(aiFullSermonSuggestion, 'ğŸ’¡ AI ì„¤êµ ê°œìš”/ë©”ì‹œì§€ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤', 'info');
};
</script>
</body>
</html>
 