<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê°•í•´ ì„¤êµ ì‘ì„±</title>
    <style>
      :root {
        --bg-top: #0a0f1a;
        --bg-bottom: #142030;
        --panel: #121e2a;
        --primary: #29b6f6;
        --btn: #007b8a;
        --btn-hover: #0096a8;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 30px;
        font-family: "Nanum Gothic", sans-serif;
        background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom));
        color: #f0f0f0;
      }
      h2 {
        color: var(--primary);
        text-align: center;
        margin: 0;
      }
      label {
        display: block;
        margin: 20px 0 6px;
      }
      .container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: space-between;
        margin-top: 40px;
      }
      .section {
        flex: 1 1 420px;
        min-width: 320px;
        display: flex;
        flex-direction: column;
      }
      textarea,
      input[type="text"] {
        background: var(--panel);
        border: none;
        padding: 12px;
        color: #f0f0f0;
        font-size: 15px;
        border-radius: 6px;
        resize: both;
      }
      textarea {
        min-height: 140px;
      }
      button {
        padding: 10px 20px;
        font-size: 15px;
        border: none;
        border-radius: 5px;
        background: var(--btn);
        color: #fff;
        cursor: pointer;
      }
      button:hover {
        background: var(--btn-hover);
      }
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
      }
      pre {
        background: var(--panel);
        padding: 12px;
        border-radius: 6px;
        white-space: pre-wrap;
        overflow-x: auto;
        min-height: 140px;
      }
      /* ëª¨ë°”ì¼ ëŒ€ì‘ */
      @media (max-width: 600px) {
        button {
          flex: 1 1 100%;
        }
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“– ê°•í•´ ì„¤êµ ì‘ì„±</h2>

    <!-- ë‹¨ì¼ êµ¬ì ˆ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <label for="bibleInput">ì„±ê²½ ì…ë ¥ (ì˜ˆ: ìš”í•œë³µìŒ 3ì¥ 16ì ˆ)</label>
    <div class="button-group" style="margin: 0 0 10px 0">
      <input
        type="text"
        id="bibleInput"
        placeholder="ì˜ˆ: ìš”í•œë³µìŒ 3ì¥ 16ì ˆ"
        style="flex: 1 1 250px"
      />
      <button onclick="loadBibleText()">ğŸ“˜ ë§ì”€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    <textarea
      id="bibleText"
      placeholder="ğŸ“– ì„±ê²½ êµ¬ì ˆì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."
      onmouseup="handleSelection()"
    ></textarea>

    <!-- êµ¬ì ˆ ë²”ìœ„ ê²€ìƒ‰ -->
    <label for="rangeInput">êµ¬ì ˆ ë²”ìœ„ (ì˜ˆ: ë¡œë§ˆì„œ 8:28~30)</label>
    <div class="button-group" style="margin: 0 0 10px 0">
      <input
        id="rangeInput"
        placeholder="ì˜ˆ: ë¡œë§ˆì„œ 8:28~30"
        style="flex: 1 1 250px"
      />
      <button onclick="searchRange()">ğŸ” êµ¬ì ˆ ê²€ìƒ‰</button>
      <button onclick="insertRangeToSermon()">ğŸ“ ì„¤êµë¬¸ì— ì‚½ì…</button>
    </div>
    <pre id="bibleResult"></pre>

    <div class="container">
      <!-- AI ì£¼ì„ -->
      <div class="section">
        <h3>AI ì£¼ì„</h3>
        <textarea id="aiResult" placeholder="AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
        <div class="button-group">
          <button onclick="callAI()">AI ì£¼ì„ ìƒì„±</button>
          <button onclick="insertAiToSermon()">ğŸ“¥ ì„¤êµë¬¸ì— ì‚½ì…</button>
        </div>
      </div>

      <!-- ì„¤êµë¬¸ -->
      <div class="section">
        <h3>ì„¤êµë¬¸ ì‘ì„±</h3>
        <textarea id="sermonText" placeholder="AI ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ì„¤êµë¬¸ì„ ì‘ì„±í•´ë³´ì„¸ìš”..."></textarea>
        <div class="button-group">
          <button onclick="saveToFirebase()">Firebase ì €ì¥</button>
          <button onclick="window.print()">ğŸ–¨ ì¸ì‡„</button>
          <button onclick="exportToPDF()">PDF ì €ì¥</button>
          <button onclick="correctGrammar()">ë¬¸ë²• êµì •</button>
          <button onclick="summarizeSermon()">ìš”ì•½/ì •ë¦¬</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
      /**************** Firebase ì´ˆê¸°í™” ****************/
      const firebaseConfig = {
        apiKey: "AIzaSyB1YVJr-aPDADp-SgYtA9X2XagYoTTJn4M",
        authDomain: "sermonnote-live.firebaseapp.com",
        projectId: "sermonnote-live"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      /**************** ê³µí†µ ë°ì´í„° ****************/
      const mapping = {
        "ì°½ì„¸ê¸°": "Genesis",
        "ì¶œì• êµ½ê¸°": "Exodus",
        "ë ˆìœ„ê¸°": "Leviticus",
        "ë¯¼ìˆ˜ê¸°": "Numbers",
        "ì‹ ëª…ê¸°": "Deuteronomy",
        "ë§ˆíƒœë³µìŒ": "Matthew",
        "ë§ˆê°€ë³µìŒ": "Mark",
        "ëˆ„ê°€ë³µìŒ": "Luke",
        "ìš”í•œë³µìŒ": "John",
        "ë¡œë§ˆì„œ": "Romans",
        "ì‹œí¸": "Psalms",
        "ì ì–¸": "Proverbs"
        // í•„ìš” ì‹œ ì¶”ê°€
      };

      /**************** ë‹¨ì¼ êµ¬ì ˆ ****************/
      function convertToEnglishRef(korean) {
        const regex = /([ê°€-í£]+)\s*(\d+)ì¥\s*(\d+)ì ˆ/;
        const match = korean.match(regex);
        if (!match) return "";
        const [, bookKr, chap, verse] = match;
        const bookEn = mapping[bookKr] || "";
        return `${bookEn} ${chap}:${verse}`;
      }

      async function loadBibleText() {
        const krText = document.getElementById("bibleInput").value.trim();
        const bibleText = document.getElementById("bibleText");
        if (!krText) return (bibleText.value = "âš ï¸ ì…ë ¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
        bibleText.value = "ğŸ“– ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        try {
          const res = await fetch("/krv.json");
          const json = await res.json();
          const engKey = convertToEnglishRef(krText);
          const verse = json[engKey];
          bibleText.value = verse || "âŒ ì„±ê²½ êµ¬ì ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        } catch (e) {
          bibleText.value = "âŒ ì˜¤ë¥˜: " + e.message;
        }
      }

      /**************** ë²”ìœ„ êµ¬ì ˆ ****************/
      function parseKoreanRange(korean) {
        const regex = /([ê°€-í£]+)\s*(\d+):(\d+)\s*~\s*(\d+)/;
        const match = korean.match(regex);
        if (!match) return null;
        const [, bookKr, chap, verseStart, verseEnd] = match;
        const bookEn = mapping[bookKr] || "";
        return {
          book: bookEn,
          chapter: chap,
          start: parseInt(verseStart),
          end: parseInt(verseEnd)
        };
      }

      async function searchRange() {
        const input = document.getElementById("rangeInput").value.trim();
        const resultArea = document.getElementById("bibleResult");
        if (!input) return (resultArea.textContent = "âš ï¸ ì…ë ¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
        resultArea.textContent = "ğŸ“– ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        const parsed = parseKoreanRange(input);
        if (!parsed) {
          resultArea.textContent = "âŒ êµ¬ì ˆ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.";
          return;
        }
        try {
          const res = await fetch("/krv.json");
          const data = await res.json();
          let output = "";
          for (let i = parsed.start; i <= parsed.end; i++) {
            const key = `${parsed.book} ${parsed.chapter}:${i}`;
            const verse = data[key];
            if (verse) output += `${key} - ${verse}\n`;
          }
          resultArea.textContent = output || "âŒ í•´ë‹¹ êµ¬ì ˆì´ ì—†ìŠµë‹ˆë‹¤.";
        } catch (e) {
          resultArea.textContent = "âŒ ì˜¤ë¥˜: " + e.message;
        }
      }

      function insertRangeToSermon() {
        const text = document.getElementById("bibleResult").textContent;
        const sermon = document.getElementById("sermonText");
        sermon.value += "\n\n" + text;
      }

      /**************** AI ê¸°ëŠ¥ ****************/
      async function callAI() {
        const text = document.getElementById("bibleText").value.trim();
        const aiArea = document.getElementById("aiResult");
        if (!text) return (aiArea.value = "âš ï¸ ë¶„ì„í•  ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
        aiArea.value = "ğŸ”„ AI ë¶„ì„ ì¤‘...";
        try {
          const res = await fetch("/ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: text })
          });
          const data = await res.json();
          aiArea.value = data.result || "âœ… ê²°ê³¼ ì—†ìŒ";
        } catch (e) {
          aiArea.value = "âŒ AI í˜¸ì¶œ ì‹¤íŒ¨: " + e.message;
        }
      }

      function insertAiToSermon() {
        const ai = document.getElementById("aiResult").value;
        const sermon = document.getElementById("sermonText");
        sermon.value += `\n\n[AI ì£¼ì„]\n${ai}`;
      }

      async function handleSelection() {
        const selection = window.getSelection().toString();
        if (selection.length === 0) return;
        try {
          const res = await fetch("/ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: `ì´ ì„±ê²½ êµ¬ì ˆì„ ì£¼ì„í•´ì¤˜: ${selection}` })
          });
          const data = await res.json();
          document.getElementById("aiResult").value += `\n\n[ì£¼ì„] ${selection}:\n${data.result}`;
        } catch (err) {
          console.error("ì£¼ì„ ì˜¤ë¥˜:", err);
        }
      }

      /**************** ì €ì¥ & ë³´ì¡° ê¸°ëŠ¥ ****************/
      async function saveToFirebase() {
        const content = document.getElementById("sermonText").value;
        if (!content.trim()) return alert("âš ï¸ ì„¤êµë¬¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
        await db.collection("sermons").add({ content, timestamp: new Date() });
        alert("âœ… ì €ì¥ ì™„ë£Œ!");
      }

      function exportToPDF() {
        import("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js").then(
          ({ default: html2pdf }) => {
            const element = document.getElementById("sermonText");
            html2pdf().from(element.value).save("sermon.pdf");
          }
        );
      }

      function correctGrammar() {
        alert("ğŸ›  ë¬¸ë²• êµì • ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.");
      }

      function summarizeSermon() {
        const txt = document.getElementById("sermonText").value;
        alert("ğŸ“ ìš”ì•½ ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.\n\në¯¸ë¦¬ë³´ê¸°ë¥¼ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤:\n" + txt.slice(0, 200) + "...");
      }
    </script>
  </body>
</html>
